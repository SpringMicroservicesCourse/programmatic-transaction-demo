# Spring 編程式交易示範專案

這個專案展示了如何在 Spring Boot 應用程式中使用編程式交易（Programmatic Transaction）。

## 功能特色

- 使用 `TransactionTemplate` 進行編程式交易管理
- 展示交易回滾（Rollback）操作
- 使用 JdbcTemplate 進行資料庫操作
- 採用 H2 內存資料庫

## 技術棧

- Java 17
- Spring Boot 3.4.5
- Spring JDBC
- H2 Database
- Lombok
- Maven

## 專案結構

```
src/main/java/tw/fengqing/spring/data/demo/
└── ProgrammaticTransactionDemoApplication.java  # 主應用程式

src/main/resources/
└── schema.sql                                   # 資料庫表結構
```

## 核心程式碼說明

### 1. 交易操作示例 (ProgrammaticTransactionDemoApplication.java)
```java
@SpringBootApplication
@Slf4j
public class ProgrammaticTransactionDemoApplication implements CommandLineRunner {
    // TransactionTemplate：Spring 提供的編程式交易管理工具
    // 相較於 @Transactional，可以在程式中精確控制交易的範圍和行為
    @Autowired
    private TransactionTemplate transactionTemplate;

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Override
    public void run(String... args) throws Exception {
        // 交易開始前的資料狀態
        log.info("COUNT BEFORE TRANSACTION: {}", getCount());

        // 使用 TransactionTemplate 執行交易操作
        // 這裡使用 TransactionCallbackWithoutResult 因為不需要返回值
        transactionTemplate.execute(new TransactionCallbackWithoutResult() {
            @Override
            protected void doInTransactionWithoutResult(TransactionStatus transactionStatus) {
                // 在交易中執行資料庫操作
                jdbcTemplate.execute("INSERT INTO FOO (ID, BAR) VALUES (1, 'aaa')");
                
                // 觀察交易中的資料狀態（此時資料是可見的）
                log.info("COUNT IN TRANSACTION: {}", getCount());
                
                // 手動設置交易回滾
                // 這將導致交易中的所有操作被撤銷
                transactionStatus.setRollbackOnly();
            }
        });

        // 交易結束後的資料狀態（由於回滾，應該與交易前相同）
        log.info("COUNT AFTER TRANSACTION: {}", getCount());
    }

    private long getCount() {
        return (long) jdbcTemplate.queryForList("SELECT COUNT(*) AS CNT FROM FOO")
                .get(0).get("CNT");
    }
}
```

### 2. 資料庫結構 (schema.sql)
```sql
CREATE TABLE FOO (
    ID INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    BAR VARCHAR(64)
);
```

## 程式碼亮點

1. **編程式交易管理**
   - TransactionTemplate 的使用
     * 提供比 @Transactional 更靈活的交易控制
     * 可以在交易執行過程中動態決定是否回滾
   - 交易回滾示範
     * 通過 setRollbackOnly() 手動觸發回滾
     * 展示交易的原子性：要麼全部成功，要麼全部失敗

2. **交易狀態觀察**
   - 記錄了交易的完整生命週期：
     * 交易前：初始狀態
     * 交易中：暫時性變更
     * 交易後：回滾後的最終狀態

## 快速開始

1. 確認已安裝 Java 17 與 Maven

2. 下載專案
```bash
git clone https://github.com/SpringMicroservicesCourse/programmatic-transaction-demo
cd programmatic-transaction-demo
```

3. 執行專案
```bash
mvn spring-boot:run
```

## 執行流程說明

1. 應用程式啟動時會自動創建 FOO 表
2. 執行交易操作：
   - 記錄交易前的資料數量
   - 在交易中插入一筆資料
   - 記錄交易中的資料數量
   - 手動設置交易回滾
   - 記錄交易後的資料數量（應與交易前相同）

## 注意事項

- 使用 H2 內存資料庫，應用程式重啟後資料會清空
- 本示例特意在交易中設置了回滾，用於展示交易的原子性
- 在實際應用中，應根據業務邏輯來決定是否回滾交易 

## 授權說明

本專案採用 MIT 授權條款，詳見 LICENSE 檔案。 